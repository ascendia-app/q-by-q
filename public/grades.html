<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Detailed Analytics | Q by Q</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
     <link rel="icon" type="image/png" href="favicon.PNG">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* Modal Transition Logic */
        .modal-overlay {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            display: flex !important;
            opacity: 1;
        }
        .modal-card {
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-card {
            transform: scale(1);
        }
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            background: white;
            border-radius: 24px;
            border: 1px solid #e2e8f0;
            color: #64748b;
        }
    </style>
</head>
<body style="background-color: #f8fafc; font-family: 'Inter', sans-serif;">

    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">Q<span>by</span>Q</div>
                <button id="toggleSidebar" class="toggle-btn"><i class="fas fa-bars"></i></button>
            </div>
            <nav class="nav-links compact-nav">
                <a href="dashboard.html" class="nav-item">
                    <div class="icon-box"><i class="fas fa-home"></i></div>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="index.html" class="nav-item">
                    <div class="icon-box"><i class="fas fa-book"></i></div>
                    <span class="nav-text">Practice</span>
                </a>
                <a href="syllabus.html" class="nav-item">
                    <div class="icon-box"><i class="fas fa-list-check"></i></div>
                    <span class="nav-text">Syllabus</span>
                </a>
                  <a href="timetable.html" class="nav-item">
        <div class="icon-box"><i class="fas fa-clock"></i></div>
        <span class="nav-text">Timetable</span>
    </a>
                <a href="grades.html" class="nav-item active">
                    <div class="icon-box"><i class="fas fa-graduation-cap"></i></div>
                    <span class="nav-text">Grades</span>
                </a>
                <a href="saved.html" class="nav-item">
                    <div class="icon-box"><i class="fas fa-bookmark"></i></div>
                    <span class="nav-text">Saved</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <button class="auth-btn logout-state"><i class="fas fa-sign-out-alt"></i> <span class="nav-text">Logout</span></button>
            </div>
        </aside>

        <main class="main-content">
            <div id="gradesContainer" style="max-width: 1100px; margin: 40px auto; padding: 0 20px;">
                
                <header style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end;">
                    <div>
                        <h1 style="color: #1e293b; margin: 0; font-size: 2rem;">Performance Analytics</h1>
                        <p style="color: #64748b; margin: 5px 0 0 0;">Visualizing your progress and exam readiness.</p>
                    </div>
                    <button onclick="confirmClearHistory()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 0.8rem; font-weight: 700; padding: 8px 12px; border-radius: 8px; transition: background 0.2s;">
                        <i class="fas fa-trash-alt"></i> CLEAR ALL DATA
                    </button>
                </header>

                <div class="metrics-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
                    <div class="stat-card" style="background: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0;">
                        <span style="font-size: 0.75rem; color: #94a3b8; font-weight: 700; text-transform: uppercase;">Papers Solved</span>
                        <div id="stat-count" style="font-size: 1.8rem; font-weight: 800; color: #1e293b; margin-top: 5px;">0</div>
                    </div>
                    <div class="stat-card" style="background: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0;">
                        <span style="font-size: 0.75rem; color: #94a3b8; font-weight: 700; text-transform: uppercase;">Avg. Accuracy</span>
                        <div id="stat-avg" style="font-size: 1.8rem; font-weight: 800; color: #0d9488; margin-top: 5px;">0%</div>
                    </div>
                    <div class="stat-card" style="background: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0;">
                        <span style="font-size: 0.75rem; color: #94a3b8; font-weight: 700; text-transform: uppercase;">Estimated Grade</span>
                        <div id="stat-grade" style="font-size: 1.8rem; font-weight: 800; color: #6366f1; margin-top: 5px;">-</div>
                    </div>
                    <div class="stat-card" style="background: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0;">
                        <span style="font-size: 0.75rem; color: #94a3b8; font-weight: 700; text-transform: uppercase;">Total Marks</span>
                        <div id="stat-marks" style="font-size: 1.8rem; font-weight: 800; color: #1e293b; margin-top: 5px;">0</div>
                    </div>
                    <div class="stat-card" style="background: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0;">
                        <span style="font-size: 0.75rem; color: #94a3b8; font-weight: 700; text-transform: uppercase;">Practice Streak</span>
                        <div id="stat-streak" style="font-size: 1.8rem; font-weight: 800; color: #f59e0b; margin-top: 5px;">0 Days</div>
                    </div>
                    <div class="stat-card" style="background: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0;">
                        <span style="font-size: 0.75rem; color: #94a3b8; font-weight: 700; text-transform: uppercase;">Best Session</span>
                        <div id="stat-best" style="font-size: 1.8rem; font-weight: 800; color: #ec4899; margin-top: 5px;">0%</div>
                    </div>
                </div>

                <div class="graphs-container" style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 40px;">
                    <div style="background: white; padding: 25px; border-radius: 20px; border: 1px solid #e2e8f0;">
                        <h3 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem;">Score Trend over Time</h3>
                        <canvas id="trendChart" height="120"></canvas>
                    </div>
                    <div style="background: white; padding: 25px; border-radius: 20px; border: 1px solid #e2e8f0;">
                        <h3 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1rem;">Accuracy Distribution</h3>
                        <canvas id="accuracyChart"></canvas>
                    </div>
                </div>

                <h3 style="color: #1e293b; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-history" style="color: #94a3b8;"></i> Attempt History
                </h3>
                <div id="gradesList"></div>
            </div>
        </main>
    </div>

    <div id="customModal" class="modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 10000; align-items: center; justify-content: center;">
        <div class="modal-card" style="background: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 24px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
            <div id="modalIconBox" style="width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px auto; font-size: 1.5rem;">
                <i id="modalIcon"></i>
            </div>
            <h2 id="modalTitle" style="margin: 0; color: #1e293b; font-size: 1.4rem; font-weight: 800;">Title</h2>
            <p id="modalDesc" style="color: #64748b; margin: 10px 0 25px 0; line-height: 1.5; font-size: 0.95rem;">Description</p>
            
            <div style="display: flex; gap: 12px;">
                <button id="modalCancel" onclick="closeModal()" style="flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; background: white; color: #64748b; font-weight: 600; cursor: pointer;">Cancel</button>
                <button id="modalConfirm" style="flex: 1; padding: 12px; border-radius: 12px; border: none; color: white; font-weight: 600; cursor: pointer;">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const history = JSON.parse(localStorage.getItem('paperHistory') || "[]");
            
            if (history.length === 0) {
                document.getElementById('gradesList').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-line" style="font-size: 3rem; opacity: 0.2; margin-bottom: 15px;"></i>
                        <p>No data yet. Complete a paper to see stats!</p>
                    </div>`;
                return;
            }

            // 1. Calculations
            const totalPapers = history.length;
            const totalGot = history.reduce((acc, curr) => acc + curr.score, 0);
            const totalMax = history.reduce((acc, curr) => acc + (curr.maxScore || 0), 0);
            const avgPercent = (history.reduce((acc, curr) => acc + parseFloat(curr.percentage), 0) / totalPapers).toFixed(1);
            
            // Grade Boundaries
            let grade = 'U';
            if (avgPercent >= 90) grade = 'A*';
            else if (avgPercent >= 80) grade = 'A';
            else if (avgPercent >= 70) grade = 'B';
            else if (avgPercent >= 60) grade = 'C';
               else if (avgPercent >= 50) grade = 'D';

            // 2. UI Update
            document.getElementById('stat-count').innerText = totalPapers;
            document.getElementById('stat-avg').innerText = avgPercent + "%";
            document.getElementById('stat-grade').innerText = grade;
            document.getElementById('stat-marks').innerText = `${totalGot}/${totalMax}`;
            document.getElementById('stat-best').innerText = Math.max(...history.map(g => parseFloat(g.percentage))) + "%";
            
            // Basic Streak (checks if last paper was done today)
            const today = new Date().toLocaleDateString();
            const doneToday = history.some(h => h.date === today);
            document.getElementById('stat-streak').innerText = doneToday ? "Active" : "Idle";

            // 3. Trend Chart
            new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: history.map(g => g.date).reverse(),
                    datasets: [{
                        label: 'Score %',
                        data: history.map(g => g.percentage).reverse(),
                        borderColor: '#0d9488',
                        backgroundColor: 'rgba(13, 148, 136, 0.05)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: '#0d9488'
                    }]
                },
                options: { 
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });

            // 4. Accuracy Chart
            new Chart(document.getElementById('accuracyChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Correct', 'Lost'],
                    datasets: [{ 
                        data: [totalGot, totalMax - totalGot], 
                        backgroundColor: ['#0d9488', '#f1f5f9'],
                        borderWidth: 0 
                    }]
                },
                options: {
                    cutout: '75%',
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            renderList(history);
        });

 function renderList(history) {
    const list = document.getElementById('gradesList');
    
    // Mapping for standardized metadata
    const sMap = { 
        'febmar': 'm', 
        'mayjun': 's', 
        'octnov': 'w' 
    };

    list.innerHTML = history.map((g, index) => {
        // 1. Generate Standardized Metadata string
        const subjectCode = (g.subject.match(/\d+/) || ["9709"])[0]; // Extracts '9709' from 'Math 9709'
        const sCode = sMap[g.season.toLowerCase()] || 's';
        const yCode = g.year.toString().slice(-2);
        
        // Ensure paper and variant are clean numbers
        const pNum = (g.paper || '1').toString().replace(/[a-zA-Z]/g, '');
        const vNum = g.variant || '1';
        
        const standardizedMeta = `${subjectCode}_${sCode}${yCode}_qp_${pNum}${vNum}`;

        return `
            <div class="grade-card" style="background:white; padding:18px 24px; border-radius:18px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center; border:1px solid #e2e8f0; position: relative; overflow: hidden;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: #cbd5e1; font-weight: 800;">#${history.length - index}</span>
                    <div>
                        <h4 style="margin:0; color:#1e293b; font-size: 1.1rem;">${g.subject}</h4>
                        <div style="font-family: monospace; background: #f1f5f9; color: #475569; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; display: inline-block; margin-top: 4px; font-weight: 600;">
                            ${standardizedMeta}
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="text-align:right;">
                        <div style="font-weight:800; color: #1e293b;">${g.score}/${g.maxScore}</div>
                        <div style="color:#0d9488; font-size:0.85rem; font-weight:700;">${g.percentage}%</div>
                    </div>
                    
                    <button onclick="deleteAttempt(${index})" style="background: #fff1f2; color: #ef4444; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-trash-alt" style="font-size: 0.8rem;"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}
function deleteAttempt(index) {
    // Open the existing custom modal for confirmation
    openModal({
        title: "Delete Attempt?",
        desc: "Are you sure you want to remove this specific paper from your history? Your stats will be recalculated.",
        icon: "fa-eraser",
        color: "#f43f5e",
        confirmText: "Remove",
        action: () => {
            const history = JSON.parse(localStorage.getItem('paperHistory') || "[]");
            
            // Remove the item at the specific index
            history.splice(index, 1);
            
            // Save back to localStorage
            localStorage.setItem('paperHistory', JSON.stringify(history));
            
            // Reload to update charts, metrics, and list
            location.reload();
        }
    });
}

        // --- REUSABLE MODAL ENGINE ---
        function openModal({ title, desc, icon, color, confirmText, action }) {
            const m = document.getElementById('customModal');
            const iconBox = document.getElementById('modalIconBox');
            const iconEl = document.getElementById('modalIcon');
            const confirmBtn = document.getElementById('modalConfirm');

            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalDesc').innerText = desc;
            
            iconEl.className = `fas ${icon}`;
            iconBox.style.background = `${color}15`;
            iconBox.style.color = color;
            
            confirmBtn.innerText = confirmText;
            confirmBtn.style.background = color;
            confirmBtn.onclick = () => { action(); closeModal(); };

            m.classList.add('active');
        }

        function closeModal() {
            document.getElementById('customModal').classList.remove('active');
        }

        function confirmClearHistory() {
            openModal({
                title: "Reset Analytics?",
                desc: "This will permanently delete your practice history. This action cannot be undone.",
                icon: "fa-trash-alt",
                color: "#ef4444",
                confirmText: "Delete Everything",
                action: () => { 
                    localStorage.removeItem('paperHistory'); 
                    location.reload(); 
                }
            });
        }

        // Example trigger for finishing a paper (can be called from other pages)
        function confirmFinishPaper() {
            openModal({
                title: "Finish & Save?",
                desc: "Are you sure you want to submit your marks and end this session?",
                icon: "fa-check-circle",
                color: "#0d9488",
                confirmText: "Save Session",
                action: () => { 
                    console.log("Paper saved!");
                    // Trigger your existing save logic here
                }
            });
        }
    </script>
</body>

